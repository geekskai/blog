---
globs: *.tsx,*.ts,app/**/*,pages/**/*
description: Next.js best practices and optimization guidelines for production-ready applications
---

# âš¡ Next.js æœ€ä½³å®è·µæ ‡å‡† - Next.js Best Practices

## ğŸ—ï¸ é¡¹ç›®ç»“æ„æ ‡å‡† (Project Structure Standards)

### ğŸ“ App Router æ¶æ„

```
app/
â”œâ”€â”€ layout.tsx                 # æ ¹å¸ƒå±€
â”œâ”€â”€ page.tsx                   # é¦–é¡µ
â”œâ”€â”€ loading.tsx                # å…¨å±€åŠ è½½ç»„ä»¶
â”œâ”€â”€ error.tsx                  # å…¨å±€é”™è¯¯ç»„ä»¶
â”œâ”€â”€ not-found.tsx              # 404é¡µé¢
â”œâ”€â”€ globals.css                # å…¨å±€æ ·å¼
â”œâ”€â”€ api/                       # APIè·¯ç”±
â”‚   â””â”€â”€ weather/
â”‚       â””â”€â”€ route.ts           # RESTful APIç«¯ç‚¹
â”œâ”€â”€ tools/                     # å·¥å…·é¡µé¢
â”‚   â””â”€â”€ snow-day-calculator/
â”‚       â”œâ”€â”€ layout.tsx         # å·¥å…·å¸ƒå±€
â”‚       â”œâ”€â”€ page.tsx           # ä¸»é¡µé¢
â”‚       â””â”€â”€ components/        # ç»„ä»¶ç›®å½•
â””â”€â”€ components/                # å…±äº«ç»„ä»¶
    â”œâ”€â”€ ui/                    # UIç»„ä»¶
    â””â”€â”€ forms/                 # è¡¨å•ç»„ä»¶
```

### ğŸ¯ ç»„ä»¶ç»„ç»‡åŸåˆ™

```tsx
// é¡µé¢ç»„ä»¶ç»“æ„æ ‡å‡†
// app/tools/[tool-name]/page.tsx
export default function ToolPage() {
  return (
    <div className="min-h-screen bg-slate-950">
      <Navigation />
      <HeroSection />
      <MainContent />
      <Footer />
    </div>
  )
}

// å¸ƒå±€ç»„ä»¶ç»“æ„
// app/tools/[tool-name]/layout.tsx
export const metadata: Metadata = {
  title: "Tool Name - Description",
  description: "Detailed description for SEO",
}

export default function ToolLayout({ children }: { children: React.ReactNode }) {
  return (
    <>
      <StructuredData />
      {children}
    </>
  )
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ (Performance Optimization)

### âš¡ ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½

```tsx
// åŠ¨æ€å¯¼å…¥å¤§å‹ç»„ä»¶
const HeavyChart = dynamic(() => import("./HeavyChart"), {
  loading: () => <ChartSkeleton />,
  ssr: false, // ä»…å®¢æˆ·ç«¯æ¸²æŸ“
})

// æ¡ä»¶æ€§åŠ è½½
const ConditionalComponent = dynamic(() => import("./ConditionalComponent"), {
  loading: () => <div>Loading...</div>,
})

// ä½¿ç”¨ç¤ºä¾‹
export default function Dashboard() {
  const [showChart, setShowChart] = useState(false)

  return (
    <div>
      <button onClick={() => setShowChart(true)}>Show Chart</button>
      {showChart && <HeavyChart />}
    </div>
  )
}
```

### ğŸ–¼ï¸ å›¾ç‰‡ä¼˜åŒ–

```tsx
import Image from "next/image"

// ä¼˜åŒ–å›¾ç‰‡ç»„ä»¶
const OptimizedImage = ({ src, alt, priority = false }) => (
  <Image
    src={src}
    alt={alt}
    width={1200}
    height={630}
    priority={priority}
    placeholder="blur"
    blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAIAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAhEAACAQMDBQAAAAAAAAAAAAABAgMABAUGIWEREiMxUf/EABUBAQEAAAAAAAAAAAAAAAAAAAMF/8QAGhEAAgIDAAAAAAAAAAAAAAAAAAECEgMRkf/aAAwDAQACEQMRAD8AltJagyeH0AthI5xdrLcNM91BF5pX2HaH9bcfaSXWGaRmknyJckliyjqTzSlT54b6bk+h0R//2Q=="
    className="rounded-lg object-cover"
    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
  />
)

// å“åº”å¼å›¾ç‰‡
const ResponsiveHero = () => (
  <div className="relative h-96 w-full">
    <Image
      src="/hero-image.jpg"
      alt="Hero Image"
      fill
      className="object-cover"
      priority
      sizes="100vw"
    />
  </div>
)
```

### ğŸ“¦ å­—ä½“ä¼˜åŒ–

```tsx
// app/layout.tsx
import { Inter, Roboto_Mono } from "next/font/google"

const inter = Inter({
  subsets: ["latin"],
  display: "swap",
  variable: "--font-inter",
})

const robotoMono = Roboto_Mono({
  subsets: ["latin"],
  display: "swap",
  variable: "--font-roboto-mono",
})

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className={`${inter.variable} ${robotoMono.variable}`}>
      <body className="font-sans">{children}</body>
    </html>
  )
}

// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      fontFamily: {
        sans: ["var(--font-inter)"],
        mono: ["var(--font-roboto-mono)"],
      },
    },
  },
}
```

## ğŸ”„ çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ (State Management)

### ğŸª Hooks ä¼˜åŒ–

```tsx
// è‡ªå®šä¹‰Hookæ¨¡æ¿
const useWeatherData = (location: string) => {
  const [data, setData] = useState<WeatherData | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string>("")

  const fetchWeather = useCallback(async (query: string) => {
    setLoading(true)
    setError("")

    try {
      const response = await fetch(`/api/weather?q=${encodeURIComponent(query)}`)
      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || "Failed to fetch weather data")
      }

      setData(result)
    } catch (err) {
      setError(err instanceof Error ? err.message : "An error occurred")
    } finally {
      setLoading(false)
    }
  }, [])

  useEffect(() => {
    if (location) {
      fetchWeather(location)
    }
  }, [location, fetchWeather])

  return { data, loading, error, refetch: fetchWeather }
}

// ä½¿ç”¨ç¤ºä¾‹
const WeatherComponent = () => {
  const [location, setLocation] = useState("")
  const { data, loading, error, refetch } = useWeatherData(location)

  if (loading) return <LoadingSpinner />
  if (error) return <ErrorDisplay error={error} onRetry={() => refetch(location)} />
  if (!data) return <EmptyState />

  return <WeatherDisplay data={data} />
}
```

### ğŸ’¾ æœ¬åœ°å­˜å‚¨ç®¡ç†

```tsx
// å®‰å…¨çš„localStorage Hook
const useLocalStorage = <T>(key: string, initialValue: T) => {
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === 'undefined') {
      return initialValue
    }

    try {
      const item = window.localStorage.getItem(key)
      return item ? JSON.parse(item) : initialValue
    } catch (error) {
      console.warn(`Error reading localStorage key "${key}":`, error)
      return initialValue
    }
  })

  const setValue = useCallback((value: T | ((val: T) => T)) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value
      setStoredValue(valueToStore)

      if (typeof window !== 'undefined') {
        window.localStorage.setItem(key, JSON.stringify(valueToStore))
      }
    } catch (error) {
      console.warn(`Error setting localStorage key "${key}":`, error)
    }
  }, [key, storedValue])

  return [storedValue, setValue] as const
}

// æœç´¢å†å²ç®¡ç†
const useSearchHistory = () => {
  const [history, setHistory] = useLocalStorage<string[]>('search-history', [])

  const addToHistory = useCallback((item: string) => {
    setHistory(prev => {
      const filtered = prev.filter(historyItem => historyItem !== item)
      return [item, ...filtered].slice(0, 5) // ä¿æŒæœ€æ–°5æ¡
    })
  }, [setHistory])

  const clearHistory = useCallback(() => {
    setHistory([])
  }, [setHistory])

  return { history, addToHistory, clearHistory }
}
```

## ğŸŒ API è®¾è®¡æ¨¡å¼ (API Design Patterns)

### ğŸ›£ï¸ API è·¯ç”±ç»“æ„

```tsx
// app/api/weather/route.ts
import { NextRequest, NextResponse } from "next/server"
import { z } from "zod"

// è¾“å…¥éªŒè¯Schema
const WeatherRequestSchema = z.object({
  type: z.enum(["city", "coords", "zip"]),
  q: z.string().optional(),
  lat: z.string().optional(),
  lon: z.string().optional(),
  zip: z.string().optional(),
})

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const params = Object.fromEntries(searchParams)

    // éªŒè¯è¾“å…¥
    const validatedParams = WeatherRequestSchema.parse(params)

    // ä¸šåŠ¡é€»è¾‘
    const weatherData = await fetchWeatherData(validatedParams)

    // è¿”å›ç»“æœ
    return NextResponse.json(weatherData, {
      headers: {
        "Cache-Control": "public, s-maxage=300, stale-while-revalidate=60",
      },
    })
  } catch (error) {
    console.error("Weather API error:", error)

    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: "Invalid request parameters", details: error.errors },
        { status: 400 }
      )
    }

    return NextResponse.json({ error: "Internal server error" }, { status: 500 })
  }
}

// è¾…åŠ©å‡½æ•°
async function fetchWeatherData(params: z.infer<typeof WeatherRequestSchema>) {
  // APIè°ƒç”¨é€»è¾‘
  const response = await fetch(buildWeatherURL(params))

  if (!response.ok) {
    throw new Error(`Weather API error: ${response.status}`)
  }

  const data = await response.json()
  return transformWeatherData(data)
}
```

### ğŸ”’ é”™è¯¯å¤„ç†æ¨¡å¼

```tsx
// app/error.tsx - å…¨å±€é”™è¯¯è¾¹ç•Œ
"use client"

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    console.error("Application error:", error)
  }, [error])

  return (
    <div className="flex min-h-screen items-center justify-center">
      <div className="text-center">
        <h2 className="mb-4 text-2xl font-bold text-red-600">Something went wrong!</h2>
        <button
          onClick={reset}
          className="rounded bg-blue-500 px-4 py-2 text-white hover:bg-blue-600"
        >
          Try again
        </button>
      </div>
    </div>
  )
}

// ç»„ä»¶çº§é”™è¯¯è¾¹ç•Œ
class ComponentErrorBoundary extends React.Component {
  constructor(props) {
    super(props)
    this.state = { hasError: false }
  }

  static getDerivedStateFromError(error) {
    return { hasError: true }
  }

  componentDidCatch(error, errorInfo) {
    console.error("Component error:", error, errorInfo)
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="p-4 text-center">
          <h3 className="text-lg font-semibold text-red-600">Component Error</h3>
          <button
            onClick={() => this.setState({ hasError: false })}
            className="mt-2 rounded bg-blue-500 px-3 py-1 text-white"
          >
            Retry
          </button>
        </div>
      )
    }

    return this.props.children
  }
}
```

## ğŸ” SEO ä¸ Meta ä¼˜åŒ–

### ğŸ“„ åŠ¨æ€Metadata

```tsx
// app/tools/[slug]/page.tsx
import type { Metadata } from "next"

interface PageProps {
  params: { slug: string }
  searchParams: { [key: string]: string | string[] | undefined }
}

export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const tool = await getToolData(params.slug)

  return {
    title: `${tool.name} - ${tool.description}`,
    description: tool.longDescription,
    keywords: tool.keywords,
    openGraph: {
      title: tool.name,
      description: tool.description,
      images: [`/tools/${params.slug}/og-image.jpg`],
    },
    twitter: {
      card: "summary_large_image",
      title: tool.name,
      description: tool.description,
      images: [`/tools/${params.slug}/twitter-image.jpg`],
    },
    alternates: {
      canonical: `https://example.com/tools/${params.slug}`,
    },
  }
}

export default function ToolPage({ params }: PageProps) {
  return <ToolComponent slug={params.slug} />
}
```

### ğŸ—ºï¸ Sitemap ç”Ÿæˆ

```tsx
// app/sitemap.ts
import { MetadataRoute } from "next"

export default function sitemap(): MetadataRoute.Sitemap {
  const tools = ["snow-day-calculator", "tip-calculator", "password-generator"]

  const toolUrls = tools.map((tool) => ({
    url: `https://example.com/tools/${tool}`,
    lastModified: new Date(),
    changeFrequency: "weekly" as const,
    priority: 0.8,
  }))

  return [
    {
      url: "https://example.com",
      lastModified: new Date(),
      changeFrequency: "yearly",
      priority: 1,
    },
    {
      url: "https://example.com/tools",
      lastModified: new Date(),
      changeFrequency: "monthly",
      priority: 0.9,
    },
    ...toolUrls,
  ]
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥ (Testing Strategy)

### ğŸ¯ ç»„ä»¶æµ‹è¯•

```tsx
// __tests__/SnowDayCalculator.test.tsx
import { render, screen, fireEvent, waitFor } from "@testing-library/react"
import { jest } from "@jest/globals"
import SnowDayCalculator from "../page"

// Mock APIè°ƒç”¨
global.fetch = jest.fn()

describe("SnowDayCalculator", () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  it("renders search form correctly", () => {
    render(<SnowDayCalculator />)

    expect(screen.getByText("Snow Day Calculator")).toBeInTheDocument()
    expect(screen.getByPlaceholderText(/enter zip code/i)).toBeInTheDocument()
    expect(screen.getByRole("button", { name: /calculate/i })).toBeInTheDocument()
  })

  it("handles search submission", async () => {
    const mockResponse = {
      location: { name: "New York", country: "US" },
      snowDay: { probability: 75, level: "High" },
    }

    ;(fetch as jest.MockedFunction<typeof fetch>).mockResolvedValue({
      ok: true,
      json: async () => mockResponse,
    } as Response)

    render(<SnowDayCalculator />)

    const input = screen.getByPlaceholderText(/enter zip code/i)
    const button = screen.getByRole("button", { name: /calculate/i })

    fireEvent.change(input, { target: { value: "10001" } })
    fireEvent.click(button)

    await waitFor(() => {
      expect(screen.getByText("75%")).toBeInTheDocument()
      expect(screen.getByText("High Chance")).toBeInTheDocument()
    })
  })
})
```

### ğŸ”„ E2E æµ‹è¯•

```tsx
// e2e/snow-day-calculator.spec.ts
import { test, expect } from "@playwright/test"

test.describe("Snow Day Calculator", () => {
  test("complete user journey", async ({ page }) => {
    await page.goto("/tools/snow-day-calculator")

    // æ£€æŸ¥é¡µé¢åŠ è½½
    await expect(page.getByText("Snow Day Calculator")).toBeVisible()

    // é€‰æ‹©æœç´¢ç±»å‹
    await page.getByLabel("Zip Code").click()

    // è¾“å…¥zip code
    await page.getByPlaceholder("Enter zip code").fill("10001")

    // æäº¤è¡¨å•
    await page.getByRole("button", { name: "Calculate Snow Day" }).click()

    // ç­‰å¾…ç»“æœ
    await expect(page.getByText(/%/)).toBeVisible({ timeout: 10000 })

    // æ£€æŸ¥ç»“æœæ˜¾ç¤º
    await expect(page.getByText(/chance/i)).toBeVisible()
  })

  test("handles geolocation", async ({ page, context }) => {
    // æ¨¡æ‹Ÿåœ°ç†ä½ç½®
    await context.grantPermissions(["geolocation"])
    await context.setGeolocation({ latitude: 40.7128, longitude: -74.006 })

    await page.goto("/tools/snow-day-calculator")

    // ç‚¹å‡»GPSæŒ‰é’®
    await page.getByTitle("Use my current location").click()

    // éªŒè¯ä½ç½®è¢«è‡ªåŠ¨å¡«å…¥
    await expect(page.getByDisplayValue(/40.7128/)).toBeVisible()
  })
})
```

è¿™å¥—Next.jsæœ€ä½³å®è·µç¡®ä¿åº”ç”¨å…·å¤‡ç”Ÿäº§çº§åˆ«çš„æ€§èƒ½ã€SEOä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒã€‚
